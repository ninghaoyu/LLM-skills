# Design Writer 步骤修复说明

## 问题描述

之前在测试时发现，最后生成的设计说明书存在两个问题：
1. **没有生成 Markdown 文件** - 只是输出文本，没有生成实际的 `.md` 文件
2. **格式不符合模板** - 生成的内容没有严格按照 `templates/design_doc_template.md` 模板编写

## 根本原因

SKILL.md 中的步骤 4 (Design Writer) 只有高层次的要求描述，缺少：

1. **明确的实现指导** - 没有具体说明如何填充模板
2. **占位符映射表** - 没有清晰的映射关系说明每个占位符从哪里来
3. **文件生成要求** - 没有明确强制生成 `.md` 文件的要求
4. **验证清单** - 没有输出验证的具体检查项
5. **Prompt 模板** - 没有提供给 LLM 的具体 Prompt 指导

这导致 LLM 在实现时自由度过大，可能选择：
- 直接输出文本而不生成文件
- 自行创造输出格式而不遵循模板
- 跳过某些章节或改变顺序

## 解决方案

### 1. 添加完整的占位符映射表

在步骤 4.1 中添加了表格，说明所有 40+ 个占位符及其数据源：

```markdown
| 占位符 | 数据源 | 填充内容 |
|-------|--------|---------|
| {PROJECT_NAME} | 步骤 1 | 项目名称 |
| {ARCHITECTURE_STYLE} | 步骤 3 | Web 三层架构/RAG 架构等 |
| ... | ... | ... |
```

### 2. 明确的文件生成要求

在"CRITICAL - 必须执行"部分强制规定：

```
- ✅ **生成完整的 Markdown 文件**（不仅仅是文本响应）
- ✅ 文件命名规则: {PROJECT_NAME}_架构设计说明书_v1.0.md
- ✅ 将文件保存到项目目录或返回给用户下载
```

### 3. 详细的章节要求

在步骤 4.2 中明确：
- 所有 11 个章节的完整清单
- 每个章节必须包含的 4 个要素：
  - 设计选择的具体内容
  - 选择理由（Why）
  - 权衡说明（Trade-off）
  - 假设标注

### 4. 文风和格式要求

在步骤 4.3 中提供：
- 文风指南（技术说明书风格）
- 具体的 Markdown 格式规范
- **完整的示例章节代码块**

示例：
```markdown
## 5. 计算层设计

### 5.1 计算服务选择

选择 **Amazon EC2 Auto Scaling Group** 作为计算层。

**选择理由 (Why)**:
- 现有应用基于 Spring Boot，迁移成本最低
- 需要完整的操作系统控制，定制化部署

**权衡 (Trade-off)**:
- ✅ 优势: ...
- ❌ 劣势: ...
- 💡 替代方案: ...
```

### 5. 验证清单

在步骤 4.5 中添加了完整的输出验证清单：

```
- [ ] 所有 11 个章节都已包含
- [ ] 所有占位符都已填充，没有 {PLACEHOLDER} 残留
- [ ] 每个技术选择都有 Why 和 Trade-off
- [ ] 假设和待确认事项都已明确标注
- [ ] 格式符合 Markdown 规范
- [ ] 文件名符合规则
- [ ] 中文语言使用正确
```

### 6. Design Writer Prompt 模板

在步骤 4.6 中提供了具体的 Prompt，包含：

```markdown
你是一名资深 AWS 解决方案架构师，需要基于已完成的架构决策，
生成标准化的《AWS 架构设计说明书》。

【执行任务】
1. **使用模板** - 打开 templates/design_doc_template.md
2. **填充占位符** - 根据输入数据逐一填充
3. **生成完整的 Markdown 文档** - 按照 11 个章节顺序
4. **输出文件** - 文件名: {PROJECT_NAME}_架构设计说明书_v1.0.md
5. **验证清单** - 检查所有要求
```

## 修改内容统计

- **修改文件**: SKILL.md 步骤 4 部分
- **新增行数**: 214 行
- **主要添加**:
  - 占位符映射表（40+ 个占位符）
  - 章节要求清单（11 个章节）
  - 文风和格式示例
  - 禁止事项清单
  - 文件命名规则
  - 验证清单
  - Design Writer Prompt 模板

## 使用指导

当调用该 Skill 时，在步骤 4 应确保：

1. **LLM 必须理解**：
   - 输出必须是实际的 Markdown 文件，而不是纯文本
   - 必须严格遵循 `templates/design_doc_template.md` 的结构
   - 必须填充所有占位符

2. **输出验证**：
   - 文件名是否符合 `{PROJECT_NAME}_架构设计说明书_v1.0.md` 格式
   - 是否包含完整的 11 个章节
   - 是否有 `{PLACEHOLDER}` 残留（如果有说明填充不完整）
   - 每个设计决策是否有 Why 和 Trade-off

3. **文件存储**：
   - 若 Skill 有文件系统访问权限，应保存为 `.md` 文件
   - 否则将完整的 Markdown 内容返回给用户

## 测试建议

测试时应检查：

1. **文件格式**
   ```bash
   # 检查是否生成了 .md 文件
   ls -la *_架构设计说明书_v1.0.md
   ```

2. **内容完整性**
   ```bash
   # 检查是否有未填充的占位符
   grep -n "{[A-Z_]*}" 文件名.md
   # 应该返回空（表示所有占位符已填充）
   ```

3. **章节完整性**
   ```bash
   # 检查是否包含 11 个主要章节
   grep "^## [0-9]" 文件名.md
   # 应该返回 11 行
   ```

4. **Why 和 Trade-off**
   ```bash
   # 检查是否包含决策理由
   grep "选择理由\|Why" 文件名.md
   grep "权衡\|Trade-off" 文件名.md
   ```

## 相关文件

- **SKILL.md** - 步骤 4 Design Writer 的详细实现指导
- **templates/design_doc_template.md** - Markdown 模板，包含所有 11 个章节和占位符
- **DEEPV.md** - 原始需求文档（第四部分 Design Writer 章节）

## 总结

通过添加详细的实现指导、占位符映射、验证清单和 Prompt 模板，
确保了 Skill 在 Design Writer 步骤中：

✅ **必须生成实际的 Markdown 文件**
✅ **必须严格遵循模板结构**
✅ **必须填充所有占位符**
✅ **必须完整包含所有 11 个章节**
✅ **必须为每个决策提供 Why 和 Trade-off**

这解决了之前"没有生成文件"和"格式不符合模板"的问题。
